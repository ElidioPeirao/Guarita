<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Acesso - Guarita</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados */
        .view {
            display: none; /* Todas as telas começam escondidas */
        }
        #loading-view {
            display: flex; /* A tela de loading é a primeira */
        }
        /* Correção para vídeo no iOS/Safari */
        video {
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            width: 100%;
            border-radius: 0.75rem; /* rounded-xl */
        }
    </style>
</head>
<body class="bg-slate-100 font-sans antialiased flex items-center justify-center min-h-screen p-4">

    <!-- Container Principal - "cartão" centralizado -->
    <div class="container mx-auto max-w-lg bg-white rounded-xl shadow-2xl overflow-hidden">

        <!-- 1. Tela de Carregamento Inicial -->
        <div id="loading-view" class="view flex-col items-center justify-center p-10">
            <h1 class="text-3xl font-bold text-gray-800">Guarita</h1>
            <p class="text-gray-500 mt-4" id="auth-status">Conectando ao sistema...</p>
            <svg class="animate-spin h-8 w-8 text-indigo-600 mt-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>

        <!-- 2. Tela de Busca (Principal da Guarita) -->
        <div id="search-view" class="view p-6 md:p-8">
            <header class="flex flex-col items-center mb-6 text-center">
                <svg class="w-12 h-12 text-indigo-600 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.623 0-1.334-.142-2.633-.402-3.896A11.959 11.959 0 0118 6c.266 0 .528.018.79.052A12.001 12.001 0 0012 2.75a11.96 11.96 0 00-1.42.186z" />
                </svg>
                <h1 class="text-3xl font-bold text-gray-800">Verificar Acesso</h1>
            </header>
            
            <div class="relative mb-4">
                <input type="text" id="search-input" class="w-full border-2 border-indigo-200 rounded-xl p-4 pl-12 text-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 outline-none" placeholder="Buscar por nome...">
                <svg class="w-6 h-6 text-gray-400 absolute left-4 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
            </div>
            
            <div id="search-results" class="space-y-2 max-h-80 overflow-y-auto">
                <p class="text-gray-500 text-center p-4">Digite ao menos 2 letras para buscar.</p>
            </div>
        </div>

        <!-- 3. Tela de Perfil do Funcionário -->
        <div id="profile-view" class="view">
            <header class="flex items-center p-4 border-b border-gray-200">
                <button id="back-to-search-btn" class="p-2 rounded-full hover:bg-slate-200 transition-colors">
                    <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h2 class="text-xl font-bold text-gray-800 text-center flex-1">Perfil do Funcionário</h2>
            </header>
            
            <!-- Conteúdo do Perfil -->
            <div class="p-6 md:p-8">
                <!-- Banner de Status -->
                <div id="profile-status-banner" class="rounded-xl p-6 mb-6 text-center shadow-lg">
                    <!-- Conteúdo preenchido por JS -->
                </div>

                <!-- Foto e Ação -->
                <div class="flex flex-col items-center mb-6">
                    <img id="profile-photo" src="https://placehold.co/150x150/e0e0e0/707070?text=Sem+Foto" alt="Foto do Funcionário" class="w-36 h-36 rounded-full object-cover border-4 border-white shadow-md mb-4">
                    <button id="profile-take-photo-btn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span>Tirar Foto</span>
                    </button>
                    <p id="photo-status-text" class="text-sm text-gray-500 mt-2">Sem foto cadastrada.</p>
                </div>

                <!-- Detalhes do Perfil -->
                <div class="space-y-4">
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <label class="block text-xs font-medium text-gray-500">Nome Completo</label>
                        <p id="profile-nome" class="text-lg font-semibold text-gray-900"></p>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <label class="block text-xs font-medium text-gray-500">Empresa (Terceirizada)</label>
                        <p id="profile-empresa" class="text-lg font-semibold text-gray-900"></p>
                    </div>
                    
                    <!-- MUDANÇA: Exibição de Serviços Múltiplos com Unidade -->
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <label class="block text-xs font-medium text-gray-500 mb-2">Serviços e Unidades</label>
                        <div id="profile-servico-container" class="flex flex-wrap gap-2">
                            <!-- Tags de serviço/unidade serão injetadas aqui -->
                        </div>
                    </div>
                    
                    <!-- MUDANÇA: Campo de Unidade Única Removido -->
                    
                    <!-- Datas Documento -->
                    <div id="profile-fap-warning-box" class="hidden bg-red-100 p-4 rounded-xl border border-red-300 text-red-800 font-medium text-center">
                        <p id="profile-fap-warning-text"></p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <label class="block text-xs font-medium text-gray-500">Documento (Emissão)</label>
                            <p id="profile-data-emissao" class="text-lg font-semibold text-gray-900"></p>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <label class="block text-xs font-medium text-gray-500">Validade Documento</label>
                            <p id="profile-data-limite" class="text-lg font-semibold text-gray-900"></p>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <label class="block text-xs font-medium text-gray-500">Solicitante / Telefone</label>
                        <p id="profile-solicitante" class="text-lg font-semibold text-gray-900"></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 4. Tela da Câmera -->
        <div id="camera-view" class="view p-6 md:p-8 bg-gray-800">
            <h1 class="text-2xl font-bold text-white text-center mb-4">Capturar Foto</h1>
            <video id="camera-video" class="w-full rounded-xl" autoplay muted playsinline></video>
            
            <button id="capture-photo-btn" class="w-full mt-4 bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-green-700 transition duration-300">
                Bater Foto
            </button>
            
            <button id="flip-camera-btn" class="w-full mt-2 bg-gray-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-gray-600 transition duration-300">
                Inverter Câmera
            </button>
            
            <button id="cancel-camera-btn" class="w-full mt-2 bg-red-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-red-700 transition duration-300">
                Cancelar
            </button>
            
            <canvas id="camera-canvas" class="hidden"></canvas>
        </div>

        <!-- 5. Caixa de Mensagem (Toast) -->
        <div id="message-box" class="fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white" style="display: none; z-index: 100;">
            <span id="message-text"></span>
        </div>

    </div> <!-- Fim do Container Principal -->

    <!-- Firebase SDKs -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc,        
            getDoc,     
            updateDoc,  
            onSnapshot, 
            query, 
            where,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadString, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        // Configuração do Firebase
        const firebaseConfigFromUser = {
            apiKey: "AIzaSyA92NNgMIsIqa5tnxyzHuE6DZIVWG2odKg",
            authDomain: "guaritasenai-9f5dd.firebaseapp.com",
            projectId: "guaritasenai-9f5dd",
            storageBucket: "guaritasenai-9f5dd.firebasestorage.app",
            messagingSenderId: "343795654991",
            appId: "1:343795654991:web:5780d957495bb07a17253a",
            measurementId: "G-0606Z0LF58"
        };
        
        // --- Variáveis Globais ---
        const firebaseConfig = firebaseConfigFromUser; 
        let app, auth, db, storage;
        let userId = null;
        let funcionariosCollectionRef;
        let currentEmployeeId = null;
        
        let allEmployees = [];
        let unsubscribeFromList = null;
        
        const videoElement = document.getElementById('camera-video');
        const canvasElement = document.getElementById('camera-canvas');
        let videoStream;
        let currentFacingMode = 'environment';
        
        const views = document.querySelectorAll('.view');
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        
        // --- Funções Auxiliares ---

        function showView(viewId) {
             views.forEach(view => {
                view.style.display = 'none';
            });
            const viewToShow = document.getElementById(viewId);
            if (viewToShow) {
                // loading-view é 'flex', outros são 'block'
                viewToShow.style.display = (viewId === 'loading-view') ? 'flex' : 'block';
            } else {
                console.error("View não encontrada:", viewId);
            }
        }

        function showMessage(message, isError = false) {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            messageText.textContent = message;
            messageBox.className = 'fixed bottom-4 right-4 p-4 rounded-xl shadow-lg text-white';
            messageBox.classList.add(isError ? 'bg-red-600' : 'bg-green-600');
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        }

        function formatarData(dataStr) {
            if (!dataStr) return 'N/A';
            try {
                const [ano, mes, dia] = dataStr.split('-');
                return `${dia}/${mes}/${ano}`;
            } catch (e) {
                return dataStr;
            }
        }

        // --- Lógica Principal da Aplicação ---

        async function initializeAppLogic() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
                setLogLevel('Debug'); 

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Usuário autenticado:", userId);
                        
                        const collectionPath = `funcionarios_terceirizados`;
                        console.log(`Usando coleção: ${collectionPath}`);
                        funcionariosCollectionRef = collection(db, collectionPath);
                        
                        document.getElementById('auth-status').textContent = "Carregando dados...";
                        
                        loadAllEmployees(); 
                        showView('search-view');

                    } else {
                        console.log("Nenhum usuário. Tentando login anônimo...");
                        document.getElementById('auth-status').textContent = "Autenticando...";
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Erro no login anônimo:", error);
                            document.getElementById('auth-status').textContent = "Falha na autenticação.";
                            showMessage("Falha grave de autenticação: " + error.message, true);
                        }
                    }
                });

            } catch (error) {
                console.error("Erro na inicialização do Firebase:", error);
                document.getElementById('auth-status').textContent = "Erro crítico na inicialização.";
                showMessage("Erro ao conectar com Firebase: " + error.message, true);
            }
        }
        
        function loadAllEmployees() {
            if (unsubscribeFromList) unsubscribeFromList();
            
            unsubscribeFromList = onSnapshot(funcionariosCollectionRef, (querySnapshot) => {
                allEmployees = [];
                querySnapshot.docs.forEach(doc => {
                    allEmployees.push({ id: doc.id, ...doc.data() });
                });
                
                console.log(`Carregados ${allEmployees.length} funcionários no cache local.`);
                document.getElementById('auth-status').textContent = "Conectado";
                
                const searchTerm = searchInput.value.trim().toLowerCase();
                if (searchTerm.length > 1) {
                    performSearch(searchTerm);
                }

            }, (error) => {
                console.error("Erro ao carregar funcionários (onSnapshot):", error);
                showMessage("Erro ao carregar dados. Verifique as Regras de Segurança do Firestore.", true);
                document.getElementById('auth-status').textContent = "Erro de permissão.";
            });
        }

        // --- Lógica de Busca ---

        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.trim().toLowerCase();
            performSearch(searchTerm);
        });

        function performSearch(searchTerm) {
            if (searchTerm.length < 2) {
                searchResults.innerHTML = '<p class="text-gray-500 text-center p-4">Digite ao menos 2 letras.</p>';
                return;
            }

            if (allEmployees.length === 0) {
                searchResults.innerHTML = '<p class="text-gray-500 text-center">Nenhum funcionário cadastrado.</p>';
                return;
            }

            const filtered = allEmployees.filter(emp => 
                emp.nomeCompletoLower && emp.nomeCompletoLower.includes(searchTerm)
            );

            if (filtered.length === 0) {
                searchResults.innerHTML = '<p class="text-gray-500 text-center">Nenhum funcionário encontrado.</p>';
                return;
            }

            searchResults.innerHTML = '';
            
            filtered.forEach(data => {
                const el = document.createElement('div');
                el.className = 'p-4 bg-white rounded-lg shadow-sm border border-gray-100 hover:bg-indigo-50 cursor-pointer transition-colors';
                el.innerHTML = `
                    <h3 class="text-lg font-semibold text-indigo-700">${data.nomeCompleto}</h3>
                    <p class="text-gray-600">${data.empresa}</p>
                `;
                el.addEventListener('click', () => showProfile(data));
                searchResults.appendChild(el);
            });
        }
        
        // --- Lógica de Perfil ---
        
        document.getElementById('back-to-search-btn').addEventListener('click', () => {
            searchInput.value = '';
            searchResults.innerHTML = '<p class="text-gray-500 text-center p-4">Digite ao menos 2 letras.</p>';
            showView('search-view');
        });

        function showProfile(data) {
            currentEmployeeId = data.id;
            
            try {
                document.getElementById('profile-nome').textContent = data.nomeCompleto || 'N/A';
                document.getElementById('profile-empresa').textContent = data.empresa || 'N/A';
                document.getElementById('profile-solicitante').textContent = `${data.solicitante || 'N/A'} / ${data.telefoneSolicitante || 'N/A'}`;

                // MUDANÇA: Exibe múltiplos serviços e unidades
                const servicoContainer = document.getElementById('profile-servico-container');
                servicoContainer.innerHTML = ''; // Limpa
                
                const servicos = data.servicos || [];
                // Fallback para dados antigos
                if (servicos.length === 0 && data.servico && data.unidade) {
                    servicos.push({ nome: data.servico, unidade: data.unidade });
                }

                if (servicos.length > 0) {
                    servicos.forEach(s => {
                        const el = document.createElement('span');
                        // Mostra NOME (UNIDADE)
                        el.textContent = `${s.nome || 'N/A'} (${s.unidade || 'N/A'})`;
                        // Estilo de "tag"
                        el.className = 'inline-block bg-indigo-100 text-indigo-800 text-base font-semibold px-3 py-1 rounded-full';
                        servicoContainer.appendChild(el);
                    });
                } else {
                    const p = document.createElement('p');
                    p.textContent = 'N/A';
                    p.className = 'text-lg font-semibold text-gray-900';
                    servicoContainer.appendChild(p);
                }


                // Lógica de Documento (FAP/ASO)
                const tipoDoc = data.tipoDocumento || 'FAP'; // Padrão FAP para registros antigos
                document.getElementById('profile-data-emissao').textContent = `${tipoDoc} (${formatarData(data.dataEmissao)})`;
                document.getElementById('profile-data-limite').textContent = formatarData(data.dataLimite);
                
                // Atualiza a foto
                const photoStatusText = document.getElementById('photo-status-text');
                const profilePhoto = document.getElementById('profile-photo');
                if (data.fotoUrl) {
                    profilePhoto.src = data.fotoUrl;
                    photoStatusText.textContent = "Foto cadastrada.";
                    photoStatusText.className = "text-sm text-green-600 mt-2";
                } else {
                    profilePhoto.src = 'https://placehold.co/150x150/e0e0e0/707070?text=Sem+Foto';
                    photoStatusText.textContent = "Sem foto cadastrada.";
                    photoStatusText.className = "text-sm text-red-600 mt-2";
                }

                // Lógica de Status (Autorizado/Não Autorizado)
                const banner = document.getElementById('profile-status-banner');
                const fapWarningBox = document.getElementById('profile-fap-warning-box');
                const fapWarningText = document.getElementById('profile-fap-warning-text');
                fapWarningBox.style.display = 'none';
                
                let autorizado = true;
                let mensagem = "";
                let docVencido = false;

                if (!data.dataLimite) {
                    autorizado = false;
                    mensagem = "Cadastro incompleto (Documento não registrado).";
                } else {
                    const hoje = new Date();
                    hoje.setHours(0, 0, 0, 0);
                    const dataLimite = new Date(data.dataLimite + "T00:00:00");
                    
                    if (dataLimite < hoje) {
                        autorizado = false;
                        mensagem = `${tipoDoc} Vencido.`;
                        docVencido = true;
                    }
                }

                if (autorizado) {
                    banner.className = 'rounded-xl p-6 mb-6 text-center shadow-lg bg-green-100 text-green-800';
                    banner.innerHTML = `
                        <svg class="w-16 h-16 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <h2 class="text-3xl font-bold">AUTORIZADO</h2>
                    `;
                } else {
                    banner.className = 'rounded-xl p-6 mb-6 text-center shadow-lg bg-red-100 text-red-800';
                    banner.innerHTML = `
                        <svg class="w-16 h-16 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <h2 class="text-3xl font-bold">NÃO AUTORIZADO</h2>
                        <p class="text-lg font-medium mt-1">${mensagem}</p>
                    `;
                    if (docVencido) {
                        fapWarningText.textContent = `${tipoDoc} VENCIDO`;
                        fapWarningBox.style.display = 'block';
                    }
                }
                
                showView('profile-view');

            } catch (error) {
                console.error("Erro ao carregar perfil:", error);
                showMessage("Erro ao carregar perfil: " + error.message, true);
            }
        }
        
        // --- Lógica da Câmera ---

        function stopCameraStream() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => {
                    track.stop();
                });
                videoStream = null;
                videoElement.srcObject = null;
                console.log("Stream da câmera parado.");
            }
        }

        async function startCameraStream(facingMode) {
            stopCameraStream();
            
            const constraints = {
                video: { 
                    facingMode: { exact: facingMode },
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            };

            try {
                console.log(`Tentando iniciar câmera com facingMode: ${facingMode}`);
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = videoStream;
                await videoElement.play();
                console.log("Câmera iniciada.");
            } catch (err) {
                console.error("Erro ao acessar a câmera: ", err);
                // Se falhar (ex: PC sem câmera traseira), tenta a outra.
                if (err.name === 'OverconstrainedError' || err.name === 'NotFoundError' || err.name === 'NotAllowedError' || err.name === 'Source/sink not found') {
                    if (facingMode === 'environment') {
                        console.warn("Câmera traseira falhou, tentando câmera frontal...");
                        currentFacingMode = 'user';
                        await startCameraStream('user'); // Tenta a frontal
                    } else {
                        // Se a frontal falhar, mostra o erro.
                         showMessage(`Erro ao acessar câmera (${err.name}). Verifique permissões.`, true);
                         stopCameraStream();
                         showView('profile-view');
                    }
                } else {
                     showMessage(`Erro ao acessar câmera (${err.name}).`, true);
                     stopCameraStream();
                     showView('profile-view');
                }
            }
        }
        
        document.getElementById('profile-take-photo-btn').addEventListener('click', () => {
            if (!currentEmployeeId) {
                showMessage("Erro: ID do funcionário não encontrado.", true);
                return;
            }
            showView('camera-view');
            startCameraStream(currentFacingMode); 
        });

        document.getElementById('cancel-camera-btn').addEventListener('click', () => {
            stopCameraStream();
            showView('profile-view');
        });
        
        document.getElementById('flip-camera-btn').addEventListener('click', () => {
            currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
            startCameraStream(currentFacingMode);
        });

        document.getElementById('capture-photo-btn').addEventListener('click', () => {
            const context = canvasElement.getContext('2d');
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
            context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
            const photoDataUrl = canvasElement.toDataURL('image/jpeg', 0.8);
            stopCameraStream(); 
            savePhoto(photoDataUrl);
        });

        async function savePhoto(dataUrl) {
            if (!currentEmployeeId) {
                showMessage("Erro fatal: ID do funcionário perdido.", true);
                return;
            }

            const btn = document.getElementById('capture-photo-btn'); // Botão de captura
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = "Salvando...";
            
            try {
                const storagePath = `fotos_funcionarios/${currentEmployeeId}.jpg`;
                const storageRef = ref(storage, storagePath);
                
                const uploadResult = await uploadString(storageRef, dataUrl, 'data_url');
                console.log("Foto enviada:", uploadResult);

                const downloadURL = await getDownloadURL(uploadResult.ref);
                
                const docRef = doc(db, funcionariosCollectionRef.path, currentEmployeeId);
                await updateDoc(docRef, {
                    fotoUrl: downloadURL
                });

                showMessage("Foto salva com sucesso!", false);
                
                const updatedEmployeeData = allEmployees.find(emp => emp.id === currentEmployeeId);
                if (updatedEmployeeData) {
                    updatedEmployeeData.fotoUrl = downloadURL;
                    showProfile(updatedEmployeeData); // Recarrega o perfil com a foto
                } else {
                    showView('search-view');
                }

            } catch (error) {
                console.error("Erro ao salvar foto:", error);
                showMessage("Erro ao salvar foto: " + error.message, true);
                showView('profile-view');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText; // Volta ao texto original
            }
        }

        // --- Inicialização ---
        window.addEventListener('DOMContentLoaded', initializeAppLogic);

    </script></body>
</html>
